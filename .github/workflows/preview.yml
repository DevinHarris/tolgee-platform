name: Deploy preview

on:
  push:
    tags:
      - preview/stepan/1
      - preview/stepan/2
      - preview/honza/1
      - preview/honza/2

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-java@v1
        with:
          java-version: 11

      - name: Setup node
        uses: actions/setup-node@v1
        with:
          node-version: '14.x'
      
      - name: Create branch
        run: | 
          git checkout -b preview.$(git rev-parse --short HEAD)
          git fetch --tags -f

      - name: Set git globals
        run: |
          git config --local user.email "machine@tolgee.io"
          git config --local user.name "Tolgee Machine"

      - name: Install node modules
        run: npm ci

      - name: Download translations
        run: ./gradlew updateStaticTranslations
        env:
          TOLGEE_API_KEY: ${{secrets.TOLGEE_API_KEY}}
          TOLGEE_API_URL: ${{secrets.TOLGEE_API_URL}}

      - name: Login to docker
        run: docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p "${{ secrets.DOCKERHUB_PASSWORD }}"

      - name: Set version
        id: version
        run: echo ::set-output name=VERSION::$(echo $GITHUB_REF | sed -e 's/refs\/tags\///g' -e 's/\//-/g')

      - name: Prepare for docker build
        run: ./gradlew dockerPrepare
        env:
          TOLGEE_API_KEY: ${{secrets.TOLGEE_API_KEY}}
          TOLGEE_API_URL: ${{secrets.TOLGEE_API_URL}}

      - name: Create docker image
        run: |
          docker buildx create --use 
          docker buildx build . -t tgint/tgpreview:${{ steps.version.outputs.VERSION }} --platform linux/arm64,linux/amd64 --push
        working-directory: build/docker

      - name: Pack with webapp
        if: ${{ steps.version.outputs.VERSION != '' }}
        run: ./gradlew packResources
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          TOLGEE_API_KEY: ${{secrets.TOLGEE_API_KEY}}
          TOLGEE_API_URL: ${{secrets.TOLGEE_API_URL}}

      - name: Create branch on origin
        if: ${{ steps.version.outputs.VERSION != '' }}
        run: git push --follow-tags -u origin $(git rev-parse --abbrev-ref HEAD)

      - name: Run npm release
        if: ${{ steps.version.outputs.VERSION != '' }}
        run: npm run release -- --debug
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.VERSION }}

      - name: Deploy
        uses: nickgronow/kubectl@master
        with:
          args: '"rollout restart deployment/tolgee-deployment-${{ steps.version.outputs.VERSION }}"'
          config_data: ${{ secrets.KUBERNETES_DO_SERVICE_CONFIG }}
